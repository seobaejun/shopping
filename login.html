<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 - 10쇼핑게임</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- 상단 유틸 메뉴 -->
    <div class="top-bar">
        <div class="container">
            <ul class="top-menu">
                <li><a href="#"><i class="fas fa-shopping-bag"></i> 주문내역</a></li>
                <li><a href="#"><i class="fas fa-question-circle"></i> FAQ</a></li>
                <li><a href="#"><i class="fas fa-comment"></i> 1:1문의</a></li>
                <li><a href="#"><i class="fas fa-star"></i> 사용후기</a></li>
                <li><a href="#"><i class="fas fa-keyboard"></i> 상품문의</a></li>
            </ul>
        </div>
    </div>

    <!-- 헤더 -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="index.html">
                        <h1>10쇼핑게임</h1>
                    </a>
                </div>
                <div class="search-bar">
                    <form id="searchForm">
                        <input type="text" id="searchInput" placeholder="검색어를 입력해주세요">
                        <button type="submit"><i class="fas fa-search"></i> 검색</button>
                    </form>
                </div>
                <div class="user-menu">
                    <a href="#" class="search-btn"><i class="fas fa-search"></i> 검색</a>
                    <a href="login.html" class="current-page"><i class="fas fa-user"></i> 로그인</a>
                    <a href="signup.html" class="signup-btn">
                        <i class="fas fa-user-plus"></i> 회원가입
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- 로그인 컨테이너 -->
    <main class="login-container">
        <div class="container">
            <div class="login-card">
                <h2 class="login-title">로그인</h2>
                
                <form class="login-form" id="loginForm">
                    <div class="form-group">
                        <label for="userId">아이디</label>
                        <input type="text" id="userId" name="userId" class="form-control" placeholder="아이디를 입력하세요" required>
                    </div>

                    <div class="form-group">
                        <label for="password">비밀번호</label>
                        <input type="password" id="password" name="password" class="form-control" placeholder="비밀번호를 입력하세요" required>
                    </div>

                    <div class="form-options">
                        <label class="remember-me">
                            <input type="checkbox" id="rememberMe">
                            <span>아이디 저장</span>
                        </label>
                        <div class="links">
                            <a href="#" onclick="findId(event)">아이디 찾기</a>
                            <span class="divider">|</span>
                            <a href="#" onclick="findPassword(event)">비밀번호 찾기</a>
                        </div>
                    </div>

                    <button type="submit" class="btn-login">로그인</button>
                </form>

                <div class="login-footer">
                    <p>아직 회원이 아니신가요?</p>
                    <a href="signup.html" class="btn-signup-link">회원가입</a>
                </div>
            </div>
        </div>
    </main>

    <!-- 푸터 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-top">
                <ul class="footer-links">
                    <li><a href="#">회사소개</a></li>
                    <li><a href="#">서비스이용약관</a></li>
                    <li><a href="#"><strong>개인정보처리방침</strong></a></li>
                    <li><a href="admin/index.html" class="admin-link"><i class="fas fa-user-shield"></i> 관리자</a></li>
                </ul>
            </div>
            <div class="footer-content">
                <div class="footer-info">
                    <h3>고객센터 정보</h3>
                    <ul>
                        <li>1670-4519</li>
                        <li>평일 오전 9:00 ~ 오후 6:00</li>
                        <li>점심 오후 12:00 ~ 오후 1:00</li>
                        <li>토/일/공휴일 휴무</li>
                    </ul>
                </div>
                <div class="footer-info">
                    <h3>결제 정보</h3>
                    <ul>
                        <li>하나은행 670-910020-22804 (주)딩펫씨큐리티</li>
                        <li>평일 오전 9:00 ~ 오후 6:00</li>
                    </ul>
                </div>
                <div class="footer-info">
                    <h3>배송 정보</h3>
                    <ul>
                        <li>구매가 확정 되면 배송이 시작됩니다.</li>
                    </ul>
                </div>
                <div class="footer-info">
                    <h3>QUICK</h3>
                    <ul>
                        <li><a href="#">공지사항</a></li>
                        <li><a href="#">이벤트</a></li>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">1:1문의</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="company-info">
                    <div class="logo-footer">
                        <h2>10쇼핑게임</h2>
                    </div>
                    <p>
                        회사명 (주)딩펫씨큐리티 주소 대전시 유성구 동서대로125 국립 한밭대학교 s9동 101호 사업자 등록번호 768-88-03514<br>
                        대표 송건회 전화 1670-4519 팩스 044-862-0069 통신판매업신고번호 제2025-대전유성-0691호<br>
                        개인정보 보호책임자 송건회 부가통신사업신고번호 12345호
                    </p>
                </div>
                <p class="copyright">Copyright © (주)딩펫씨큐리티. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script>
    // Firebase 초기화
    const firebaseConfig = {
        apiKey: "AIzaSyBGQdEiVOl_49oVfb8TPWkc47uaFxV55Xg",
        authDomain: "shopping-31dce.firebaseapp.com",
        projectId: "shopping-31dce",
        storageBucket: "shopping-31dce.firebasestorage.app",
        messagingSenderId: "344605730776",
        appId: "1:344605730776:web:925f9d6206b1ff2e0374ad",
        measurementId: "G-B7V6HK8Z7X"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // 로그인 폼 처리
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('userId').value.trim(); // 이메일로 변경
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            alert('이메일과 비밀번호를 입력해주세요.');
            return;
        }
        
        const loginBtn = this.querySelector('.btn-login');
        loginBtn.disabled = true;
        loginBtn.textContent = '로그인 중...';
        
        try {
            // Firebase Auth로 로그인
            const userCredential = await firebase.auth()
                .signInWithEmailAndPassword(email, password);
            
            const uid = userCredential.user.uid;
            console.log('✅ Firebase Auth 로그인 성공, UID:', uid);
            
            // Firestore에서 사용자 정보 가져오기
            const userDoc = await db.collection('members').doc(uid).get();
            
            if (!userDoc.exists) {
                alert('사용자 정보를 찾을 수 없습니다.');
                await firebase.auth().signOut();
                loginBtn.disabled = false;
                loginBtn.textContent = '로그인';
                return;
            }
            
            const userData = userDoc.data();
            
            // 로그인 성공
            const loginInfo = {
                uid: uid,
                userId: userData.userId,
                name: userData.name || userData.userId,
                email: userData.email || email
            };
            
            localStorage.setItem('loginUser', JSON.stringify(loginInfo));
            localStorage.setItem('isLoggedIn', 'true');
            
            // 관리자 여부 확인 (admins 컬렉션에서 userId 또는 name 일치 + status active)
            try {
                var isAdminUser = false;
                var adminsSnap = await db.collection('admins').where('userId', '==', userData.userId).get();
                if (!adminsSnap.empty) {
                    adminsSnap.docs.forEach(function(doc) {
                        if (doc.data().status === 'active') isAdminUser = true;
                    });
                }
                if (!isAdminUser && userData.name) {
                    adminsSnap = await db.collection('admins').get();
                    adminsSnap.docs.forEach(function(doc) {
                        var d = doc.data();
                        if (d.status === 'active' && (d.userId === userData.userId || d.name === userData.name)) isAdminUser = true;
                    });
                }
                localStorage.setItem('isAdmin', isAdminUser ? 'true' : 'false');
            } catch (e) {
                console.warn('관리자 여부 확인 실패:', e);
                localStorage.setItem('isAdmin', 'false');
            }
            
            // 아이디 저장
            if (document.getElementById('rememberMe').checked) {
                localStorage.setItem('savedEmail', email);
            } else {
                localStorage.removeItem('savedEmail');
            }
            
            console.log('✅ 로그인 완료:', loginInfo);
            alert(`${userData.name}님, 환영합니다!`);
            window.location.href = 'index.html';
            
        } catch (error) {
            console.error('❌ 로그인 오류:', error);
            
            let errorMessage = '로그인에 실패했습니다.\n';
            
            if (error.code === 'auth/user-not-found') {
                errorMessage = '존재하지 않는 이메일입니다.';
            } else if (error.code === 'auth/wrong-password') {
                errorMessage = '비밀번호가 일치하지 않습니다.';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = '올바르지 않은 이메일 형식입니다.';
            } else if (error.code === 'auth/too-many-requests') {
                errorMessage = '로그인 시도가 너무 많습니다. 잠시 후 다시 시도해주세요.';
            } else {
                errorMessage += error.message;
            }
            
            alert(errorMessage);
            loginBtn.disabled = false;
            loginBtn.textContent = '로그인';
        }
    });
    
    // 아이디 찾기 함수
    async function findId(event) {
        event.preventDefault();
        
        const name = prompt('이름을 입력하세요:');
        if (!name) return;
        
        const phone = prompt('전화번호를 입력하세요 (예: 010-1234-5678):');
        if (!phone) return;
        
        try {
            // Firestore에서 이름과 전화번호로 검색
            const snapshot = await db.collection('members')
                .where('name', '==', name)
                .where('phone', '==', phone)
                .limit(1)
                .get();
            
            if (snapshot.empty) {
                alert('일치하는 회원 정보를 찾을 수 없습니다.');
                return;
            }
            
            const userData = snapshot.docs[0].data();
            alert(`회원님의 아이디는 "${userData.userId}" 입니다.\n이메일: ${userData.email}`);
            
        } catch (error) {
            console.error('아이디 찾기 오류:', error);
            alert('아이디 찾기 중 오류가 발생했습니다.');
        }
    }
    
    // 비밀번호 찾기 함수 (Firebase Auth 이메일 발송)
    async function findPassword(event) {
        event.preventDefault();
        
        const email = prompt('가입 시 사용한 이메일을 입력하세요:');
        if (!email) return;
        
        // 이메일 형식 확인
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('올바른 이메일 형식을 입력해주세요.');
            return;
        }
        
        try {
            // Firebase Auth로 비밀번호 재설정 이메일 발송
            await firebase.auth().sendPasswordResetEmail(email);
            
            alert(`비밀번호 재설정 이메일이 ${email}로 발송되었습니다.\n이메일을 확인하여 비밀번호를 재설정해주세요.`);
            
        } catch (error) {
            console.error('비밀번호 찾기 오류:', error);
            
            let errorMessage = '비밀번호 찾기 중 오류가 발생했습니다.\n';
            
            if (error.code === 'auth/user-not-found') {
                errorMessage = '가입되지 않은 이메일입니다.';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = '올바르지 않은 이메일 형식입니다.';
            } else {
                errorMessage += error.message;
            }
            
            alert(errorMessage);
        }
    }

    // 저장된 이메일 불러오기
    window.addEventListener('DOMContentLoaded', function() {
        const savedEmail = localStorage.getItem('savedEmail');
        if (savedEmail) {
            document.getElementById('userId').value = savedEmail;
            document.getElementById('rememberMe').checked = true;
        }
        
        // 라벨 텍스트도 "아이디"에서 "이메일"로 변경
        const label = document.querySelector('label[for="userId"]');
        if (label) {
            label.textContent = '이메일';
        }
        const input = document.getElementById('userId');
        if (input) {
            input.placeholder = '이메일을 입력하세요';
            input.type = 'email';
        }
    });
    </script>
    <script src="js/admin-link-visibility.js"></script>
</body>
</html>
