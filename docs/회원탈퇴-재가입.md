# 회원 탈퇴 및 재가입

## 1. 탈퇴 처리

- **마이페이지 > 회원정보 > 회원탈퇴**에서 사용자가 탈퇴 시:
  - Firestore `members` 문서는 **삭제하지 않음**.
  - 해당 문서에 아래 필드만 **업데이트**:
    - `status: 'withdrawn'`
    - `withdrawnAt`: 탈퇴 시각 (serverTimestamp)
    - `updatedAt`: 수정 시각
- 로그인 정보(localStorage) 삭제 후 메인 페이지로 이동.

---

## 2. 회원조회(관리자)에서 탈퇴 표시

- **상태** 컬럼:
  - `status === 'withdrawn'` → **"탈퇴"** 뱃지 표시 (회색 `badge-secondary`).
  - 탈퇴 회원은 상태 셀렉트(정상/대기/정지) 비표시, 변경 불가.
- **승인상태** 검색 필터에 **"탈퇴"** 옵션 추가 → 탈퇴 회원만 조회 가능.
- 엑셀 다운로드(CSV) 시 상태 컬럼에 "탈퇴"로 출력.

**관련 파일:** `admin/js/admin.js`, `admin/js/member-search.js`, `admin/index.html`

---

## 3. 재가입(복구) 흐름

탈퇴 회원이 **같은 아이디**로 다시 가입할 수 있도록, 기존 문서를 복구하는 방식으로 동작합니다.

### 3.1 회원가입 – 아이디(닉네임) 중복확인

- Firestore `members`에서 `userId`로 조회.
- **이미 같은 userId가 있을 때:**
  - 해당 회원의 `status === 'withdrawn'` →  
    **"탈퇴한 아이디입니다. 재가입하시면 같은 아이디로 다시 이용할 수 있습니다."**  
    → **사용 가능** 처리(중복확인 통과).
  - 그 외(정상/대기/정지) → **"이미 사용 중인 닉네임입니다."** → 사용 불가.
- 조회 결과 없음 → **"사용 가능한 닉네임입니다."**

### 3.2 회원가입 – 가입 처리

- 가입 버튼 클릭 후:
  1. `userId`로 `members` 조회.
  2. **status가 `withdrawn`인 문서가 있으면 (재가입):**
     - 해당 문서만 **업데이트(복구)**:
       - `status: '정상'`
       - `email`, `name`, `phone`, `postcode`, `address`, `detailAddress`, `password`, `agreeEmail`, `agreeSMS`, `agreePublic` 등 폼 값으로 갱신
       - `updatedAt` 갱신
       - `withdrawnAt` 필드 삭제
     - Firebase Auth 신규 생성 **하지 않음**.
     - **"재가입이 완료되었습니다. 입력하신 비밀번호로 로그인해 주세요."** 후 **로그인 페이지(login.html)**로 이동.
  3. **탈퇴 회원이 아니면**  
     → 기존처럼 Firebase Auth 생성 + `members`에 새 문서 생성(신규 가입).

### 3.3 로그인

- `status === 'withdrawn'`인 회원이 로그인 시도 시:
  - **"탈퇴한 계정입니다. 재가입 후 이용해 주세요."**
  - **회원가입 페이지(signup.html)**로 이동.

---

## 4. 관련 파일

| 파일 | 역할 |
|------|------|
| `js/mypage-api.js` | `withdrawMember(docId)` – 탈퇴 시 status/withdrawnAt 업데이트 |
| `js/mypage.js` | 회원탈퇴 폼 바인딩, 탈퇴 후 로그아웃·리다이렉트 |
| `js/signup.js` | 중복확인 시 탈퇴 회원 허용, 가입 시 탈퇴 문서 복구(재가입) |
| `js/login.js` | 탈퇴 회원 로그인 차단 후 signup으로 이동 |
| `admin/js/admin.js` | 회원 테이블에서 탈퇴 시 "탈퇴" 뱃지 표시 |
| `admin/js/member-search.js` | 회원조회·검색 테이블 탈퇴 표시, CSV 상태 "탈퇴" 출력 |
| `admin/index.html` | 회원조회 승인상태 필터 "탈퇴" 옵션 |

---

## 5. 정리

- **탈퇴** = 문서 유지 + `status: 'withdrawn'` 설정.
- **재가입** = 같은 `userId`로 가입 시 해당 탈퇴 문서를 복구(status 정상, 정보 갱신)하고 로그인 페이지로 이동.
- 주문·추첨 등 `memberId` 참조는 그대로 유지되며, 문서를 지우지 않으므로 이력 관리에 유리합니다.



